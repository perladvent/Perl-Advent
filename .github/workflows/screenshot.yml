---
name: Screenshot Article Preview

on:
  pull_request:
    types: [labeled, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshot:
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'preview')
    name: Generate article screenshots
    runs-on: ubuntu-latest
    container:
      image: perldocker/perl-tester:5.38
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0

      - name: ðŸ” Detect changed articles
        id: detect
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          YEAR=$(date +%Y)
          echo "year=$YEAR" >> "$GITHUB_OUTPUT"

          # Get list of changed POD files in YEAR/incoming or YEAR/articles
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E "${YEAR}/(incoming|articles)/.*\.pod$" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No article files changed"
            echo "has_articles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed article files:"
          echo "$CHANGED_FILES"

          # Store as newline-separated list for later
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "has_articles=true" >> "$GITHUB_OUTPUT"

      - name: ðŸ›‘ Exit if no articles changed
        if: steps.detect.outputs.has_articles != 'true'
        run: |
          echo "No article files changed, skipping workflow"
          exit 0

      - name: ðŸ§… Install deps using cpm
        if: steps.detect.outputs.has_articles == 'true'
        uses: perl-actions/install-with-cpm@v1
        with:
          cpanfile: 'cpanfile'
          sudo: false

      - name: ðŸ“¦ Install build dependencies
        if: steps.detect.outputs.has_articles == 'true'
        run: bash script/ci/install-deps.sh

      - name: ðŸ“š Build site
        if: steps.detect.outputs.has_articles == 'true'
        env:
          YEAR: ${{ steps.detect.outputs.year }}
        run: |
          # For incoming articles, use render-incoming.pl approach
          if echo "${{ steps.detect.outputs.changed_files }}" | grep -q "incoming"; then
            perl script/render-incoming.pl
          else
            ./script/build-site.sh --single-year "$YEAR" --today "${YEAR}-12-25"
          fi

      - name: ðŸ–¼ï¸ Setup Node.js for Playwright
        if: steps.detect.outputs.has_articles == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: ðŸŽ­ Install Playwright
        if: steps.detect.outputs.has_articles == 'true'
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: ðŸ“¸ Take screenshots
        if: steps.detect.outputs.has_articles == 'true'
        id: screenshots
        env:
          CHANGED_FILES: ${{ steps.detect.outputs.changed_files }}
          YEAR: ${{ steps.detect.outputs.year }}
        run: |
          mkdir -p screenshots

          # Start HTTP server in background
          cd out
          python3 -m http.server 8000 &
          SERVER_PID=$!
          cd ..

          # Wait for server to be ready
          sleep 3
          SERVER_READY=false
          for i in $(seq 1 10); do
            if curl -s http://localhost:8000/ > /dev/null; then
              echo "Server is ready"
              SERVER_READY=true
              break
            fi
            echo "Waiting for server... attempt $i"
            sleep 2
          done

          if [ "$SERVER_READY" = "false" ]; then
            echo "Error: Server failed to start after 10 attempts"
            exit 1
          fi

          # Run screenshot script
          node script/ci/take-screenshots.js

          # Stop server
          kill $SERVER_PID || true

          # List screenshots
          echo "Generated screenshots:"
          ls -la screenshots/

      - name: ðŸ“¤ Upload screenshots as artifacts
        if: steps.detect.outputs.has_articles == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: article-screenshots
          path: screenshots/
          retention-days: 30

      - name: ðŸ’¬ Post PR comment with screenshots
        if: steps.detect.outputs.has_articles == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const postPRComment = require('./script/ci/post-pr-comment.js');
            await postPRComment(github, context);
