---
name: Screenshot Article Preview

# Security note: This workflow uses pull_request_target to allow write access
# for PRs from forked repositories. This is safe because:
# 1. It only runs when the 'preview' label is applied (requires maintainer action)
# 2. It explicitly checks out the PR code, not the base branch
# 3. It only builds POD articles and takes screenshots - no code execution from PRs
# 4. All Docker builds are sandboxed

on:
  pull_request_target:
    types: [labeled, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshot:
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'preview')
    name: Generate article screenshots
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: true
          fetch-depth: 0

      - name: ðŸ³ Build Docker image
        run: docker compose build

      - name: ðŸ” Detect changed articles
        id: detect
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          YEAR=$(date +%Y)
          echo "year=$YEAR" >> "$GITHUB_OUTPUT"

          # Get list of changed POD files in YEAR/incoming or YEAR/articles
          # For pull_request_target, we compare against the base ref
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -E "${YEAR}/(incoming|articles)/.*\.pod$" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No article files changed"
            echo "has_articles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed article files:"
          echo "$CHANGED_FILES"

          # Store as newline-separated list for later
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "has_articles=true" >> "$GITHUB_OUTPUT"

      - name: ðŸ›‘ Exit if no articles changed
        if: steps.detect.outputs.has_articles != 'true'
        run: |
          echo "No article files changed, skipping workflow"
          exit 1

      - name: ðŸ“š Build site
        env:
          YEAR: ${{ steps.detect.outputs.year }}
        run: |
          # For incoming articles, first copy them to articles/ with sequential dates
          if echo "${{ steps.detect.outputs.changed_files }}" | grep -q "incoming"; then
            docker compose run --rm perl-advent bash -c "perl script/render-incoming.pl && bash script/build-site.sh --single-year $YEAR --today ${YEAR}-12-25"
          else
            docker compose run --rm perl-advent bash script/build-site.sh --single-year "$YEAR" --today "${YEAR}-12-25"
          fi

      - name: ðŸ“¤ Copy build output for screenshot matching
        run: |
          # Copy out directory and mapping file to host so screenshot script can read them
          docker compose run --rm perl-advent cp -r /app/out /app/out-host
          docker compose run --rm perl-advent cp /app/incoming-mappings.json /app/incoming-mappings-host.json || true
          rm -rf out
          mv out-host out
          mv incoming-mappings-host.json incoming-mappings.json 2>/dev/null || true

      - name: ðŸŒ Start web server (serves from Docker volume)
        run: docker compose up -d --no-deps perl-advent-server

      - name: ðŸ–¼ï¸ Setup Node.js for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: ðŸŽ­ Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: ðŸ“¸ Take screenshots
        id: screenshots
        env:
          CHANGED_FILES: ${{ steps.detect.outputs.changed_files }}
          YEAR: ${{ steps.detect.outputs.year }}
          SERVER_PORT: 7007
        run: |
          mkdir -p screenshots

          # Wait for server to be ready and serving the year directory
          sleep 3
          SERVER_READY=false
          for i in $(seq 1 10); do
            if curl -s "http://localhost:7007/$YEAR/" > /dev/null; then
              echo "Server is ready and serving $YEAR directory"
              SERVER_READY=true
              break
            fi
            echo "Waiting for server... attempt $i"
            sleep 2
          done

          if [ "$SERVER_READY" = "false" ]; then
            echo "Error: Server failed to start after 10 attempts"
            exit 1
          fi

          # Run screenshot script
          node script/ci/take-screenshots.js

          # List screenshots
          echo "Generated screenshots:"
          ls -la screenshots/

      - name: ðŸ›‘ Stop web server
        if: always()
        run: docker compose down

      - name: ðŸ“¤ Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: article-screenshots
          path: screenshots/
          retention-days: 30

      - name: ðŸ’¬ Post PR comment with screenshots
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const postPRComment = require('./script/ci/post-pr-comment.js');
            await postPRComment(github, context);
