<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2017 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2017.css" type="text/css" />
    <title>
Perl Advent Calendar 2017 - 
Project Multipli-sleigh-ion

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2017</a></h1>
        </div>

        <p id="tagline">2017 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Project Multipli-sleigh-ion</h1>
<div class='subtitle'>MooseX::ClassAttribute - 2017-12-18</div>

<div class='pod'><p>Project Multipli-sleigh-ion was the last, great hope for the North Pole to cope with the ever increasing child population. More children equaled more presents that had to be loaded on the sleigh and it was getting out of hand. Multipli-sleigh-ion was going to address this by replacing the vertical scaling - ever more powerful magic to fit everything in one sack - with horizontal scaling - lots of sacks of presents stashed at strategic locations around the globe for Santa to pick up en-route.</p>

<p>Rustic Starpie had been put in charge of writing modeling code to test the feasibility of this approach. In his model code each class of present consumed one common role <code>Present</code>, and in doing so was required to implement the <code>ideal_sack</code> method.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Present</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose::Role</span><span class="structure">;</span><br /><br /><span class="word">requires</span> <span class="single">'ideal_sack'</span><span class="operator">,</span> <span class="single">'name'</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">put_in_sack</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@sacks</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$ideal_sack</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">ideal_sack</span><span class="structure">(</span> <span class="symbol">@sacks</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">unless</span> <span class="structure">(</span><span class="symbol">$ideal_sack</span><span class="operator">-&gt;</span><span class="word">full</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$ideal_sack</span><span class="operator">-&gt;</span><span class="word">add_present</span><span class="structure">(</span> <span class="symbol">$self</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">die</span> <span class="double">&quot;Modeling failed, can't fit &quot;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">.</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">name</span> <span class="operator">.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">' into sack '</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">.</span> <span class="symbol">$ideal_sack</span><span class="operator">-&gt;</span><span class="word">name</span><br /><span class="structure">}</span><br /><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>The <code>ideal_sack</code> code was implemented differently in each class that consumed the <code>Present</code> role, but each implementation ultimately decided which of the passed sack objects it should put itself in. For example, the figgy puddings were for the English children, so they always went into the English sack</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">FiggyPuddingPresent</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span><br /><span class="word">with</span> <span class="single">'Present'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">List::Util</span> <span class="words">qw( first )</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">name</span> <span class="structure">{</span> <span class="single">'Figgy Pudding'</span> <span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">ideal_sack</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@sacks</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$ideal_sack</span> <span class="operator">=</span> <span class="word">first</span> <span class="structure">{</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">name</span> <span class="operator">eq</span> <span class="single">'London, UK'</span><span class="structure">}</span> <span class="symbol">@sacks</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$ideal_sack</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>The problem Rustic was having with his code is that, well, it wasn&#39;t always doing what it was supposed to in all cases. So he decided to add some debugging in the Present role to print out which sack everything was going to go into.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Present</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose::Role</span><span class="structure">;</span><br /><br /><span class="word">requires</span> <span class="single">'ideal_sack'</span><span class="operator">,</span> <span class="single">'name'</span><span class="structure">;</span><br /><br /><span class="word">around</span> <span class="word">ideal_sack</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$orig</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$ideal_sack</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="symbol">$orig</span><span class="structure">(</span><span class="magic">@_</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="heredoc">&lt;&lt;~&quot;OUT&quot;</span><span class="structure">;</span><br /><span class="heredoc_content">The ideal sack for a @{[ $self-&gt;name ]} is @{[ $ideal_sack-&gt;name ]}<br /></span><span class="heredoc_terminator">OUT<br /></span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$ideal_sack</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>This code would cause any <code>ideal_sack</code> method to be wrapped in code that produced output of the form:</p>

<pre><code>    The ideal sack for a Figgy Pudding is London, UK
    The ideal sack for a Chocolate Coin is Paris, France
    The ideal sack for a Chocolate Coin is Moscow, Russia
    The ideal sack for a Figgy Pudding is London, UK
    The ideal sack for a Chocolate Coin is London, UK
    The ideal sack for a Chocolate Coin is New York, USA
    The ideal sack for a Figgy Pudding is London, UK
    Can&#39;t fit Figgy Pudding into sack London, UK at line 16 of Present.pm.</code></pre>

<p>(The chocolate coins are distributed randomly between sacks)</p>

<p>This was <i>somewhat</i> helpful, it really isn&#39;t what Rustic wanted. He wanted to know how many Figgy Puddings he&#39;d successfully managed to put into the sack, and he really didn&#39;t want to have to count the lines of his debug output. He wanted output of the form:</p>

<pre><code>    The ideal sack for the 3214th Figgy Pudding is London, UK
    The ideal sack for the 91231st Chocolate Coin is Paris, France
    The ideal sack for the 91232nd Chocolate Coin is Moscow, Russia
    The ideal sack for the 3215th Figgy Pudding is London, UK
    The ideal sack for the 91233rd Chocolate Coin is London, UK
    The ideal sack for the 91234th Chocolate Coin is New York, USA
    The ideal sack for the 3216th Figgy Pudding is London, UK
    Can&#39;t fit Figgy Pudding into sack London, UK at line 16 of Present.pm.</code></pre>

<p>How could Rustic get Perl to keep track of the number of times <code>ideal_sack</code> had been called per class? The data can&#39;t be stored in the instances because they&#39;re distrinct from one another. What Rustic needed was some sort of class level storage.</p>

<p>Luckily, there&#39;s a module for that. <a href="https://metacpan.org/module/MooseX::ClassAttribute">MooseX::ClassAttribute</a> provides a new keyword <code>class_has</code> that defines an attribute shared at the <i>class</i> level rather than the <i>instance</i> level. All objects of the same class share the same value:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Present</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose::Role</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">MooseX::ClassAttribute</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Lingua::EN::Numbers::Ordinate</span> <span class="structure">(</span><span class="single">'ordinate'</span><span class="structure">);</span><br /><br /><span class="word">requires</span> <span class="single">'ideal_sack'</span><span class="structure">;</span><br /><br /><span class="word">class_has</span> <span class="word">_packed_counter</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>      <span class="operator">=&gt;</span> <span class="single">'rw'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">isa</span>     <span class="operator">=&gt;</span> <span class="single">'Int'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="number">0</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="word">around</span> <span class="word">ideal_sack</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$orig</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$ideal_sack</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="symbol">$orig</span><span class="structure">(</span><span class="magic">@_</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$counter</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_packed_counter</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_packed_counter</span><span class="structure">(</span> <span class="symbol">$counter</span> <span class="operator">+</span> <span class="number">1</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$c</span> <span class="operator">=</span> <span class="word">ordinate</span><span class="structure">(</span> <span class="symbol">$counter</span> <span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="heredoc">&lt;&lt;~&quot;OUT&quot;</span><span class="structure">;</span><br /><span class="heredoc_content">The ideal sack for the $c @{[ $self-&gt;name ]} is @{[ $ideal_sack-&gt;name ]}<br /></span><span class="heredoc_terminator">OUT<br /></span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$ideal_sack</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>We have the full power of Moose attributes behind the class attributes. For example, Rustic could rewrite the above to be clearer with the <a href="https://metacpan.org/module/Moose::Meta::Attribute::Native::Trait::Counter">Moose::Meta::Attribute::Native::Trait::Counter</a> trait to handle incrementing the counter.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Present</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose::Role</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">MooseX::ClassAttribute</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Lingua::EN::Numbers::Ordinate</span> <span class="structure">(</span><span class="single">'ordinate'</span><span class="structure">);</span><br /><br /><span class="word">requires</span> <span class="single">'ideal_sack'</span><span class="structure">;</span><br /><br /><span class="word">class_has</span> <span class="word">_packed_counter</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>      <span class="operator">=&gt;</span> <span class="single">'rw'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">isa</span>     <span class="operator">=&gt;</span> <span class="single">'Int'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">traits</span>  <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'Counter'</span><span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="number">0</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">handles</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_increment_packed_counter</span> <span class="operator">=&gt;</span> <span class="single">'inc'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="word">around</span> <span class="word">ideal_sack</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$orig</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$ideal_sack</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="symbol">$orig</span><span class="structure">(</span><span class="magic">@_</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_increment_packed_counter</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$c</span> <span class="operator">=</span> <span class="word">ordinate</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_packed_counter</span> <span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="heredoc">&lt;&lt;~&quot;OUT&quot;</span><span class="structure">;</span><br /><span class="heredoc_content">The ideal sack for the $c @{[ $self-&gt;name ]} is @{[ $ideal_sack-&gt;name ]}<br /></span><span class="heredoc_terminator">OUT<br /></span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$ideal_sack</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>With the new debugging output Rustic was quickly able to determine where the problems were in the code in time for his project review with the Wise Old Elf.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Making a constructor argument list, checking it twice." href="2017-12-17.html">Previous</a></li>

    <li class="next"><a title="Maybe not" href="2017-12-19.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





