<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2016 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2016.css" type="text/css" />
    <title>
Perl Advent Calendar 2016 - 
REST-oring Christmas Tranquility

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2016</a></h1>
        </div>

        <p id="tagline">2016 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>REST-oring Christmas Tranquility</h1>
<div class='subtitle'>Magpie - 2016-12-11</div>

<div class='pod'><h2 id="REST-oring-Christmas-Tranqulity">REST-oring Christmas Tranqulity</h2>

<p>So you&#39;ve been working for the last four years on the <a href="http://www.perladvent.org/2012/2012-12-24.html">Flibber API</a> your boss required that one time. Turns out that over that time you&#39;ve added APIs for Jibber, Jabber, and Flubber as well. The code base has grown and you&#39;re starting to discover that you&#39;re duplicating a lot of code between the various <a href="https://metacpan.org/module/Web::Machine">Web::Machine</a> controllers you&#39;ve built. Code like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">has</span> <span class="word">json_encoder</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>      <span class="operator">=&gt;</span> <span class="single">'bare'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy</span>    <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">builder</span> <span class="operator">=&gt;</span> <span class="single">'_build_json_encoder'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">handles</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">encode_json</span> <span class="operator">=&gt;</span> <span class="single">'encode'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">decode_json</span> <span class="operator">=&gt;</span> <span class="single">'decode'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="keyword">sub</span> <span class="word">to_json</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">encode_json</span><span class="structure">(</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">resource</span><span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Which could be refactored into a common base class, but the boss is making noises that make you think things are gonna get ugly if you&#39;re not careful. You start to wonder if maybe there is a better way.</p>

<h3 id="One-for-Sorrow-Two-for-Mirth">One for Sorrow / Two for Mirth</h3>

<p><a href="https://metacpan.org/pod/Magpie">Magpie</a> is a resource oriented framework that is based on a pipelined state machine rather than a single state machine. It&#39;s been on the CPAN for a couple years now but it&#39;s mostly been used internally by the elves at Tamarou. As a warning, the documentation is a bit rough but we&#39;re hoping to work on it over the holidays.</p>

<p>Let&#39;s start by looking back to the resource we started with four years ago.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>&nbsp;<span class="keyword">use</span> <span class="version">5.16.2</span><span class="structure">;</span><br />&nbsp;<span class="keyword">use</span> <span class="word">Web::Machine</span><span class="structure">;</span><br /><br />&nbsp;<span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">package</span> <span class="word">WasteOfTime::Resource</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">use</span> <span class="pragma">parent</span> <span class="single">'Web::Machine::Resource'</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">use</span> <span class="word">JSON::XS</span> <span class="words">qw(encode_json)</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="word">content_types_provided</span> <span class="structure">{</span> <span class="structure">[{</span> <span class="single">'application/json'</span> <span class="operator">=&gt;</span> <span class="single">'to_json'</span> <span class="structure">}]</span> <span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="word">to_json</span> <span class="structure">{</span> <span class="word">encode_json</span><span class="structure">({</span> <span class="word">time</span> <span class="operator">=&gt;</span> <span class="word">scalar</span> <span class="word">localtime</span> <span class="structure">})</span> <span class="structure">}</span><br /><span class="structure">}</span><br /><br />&nbsp;<span class="word">Web::Machine</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">resource</span> <span class="operator">=&gt;</span> <span class="single">'WasteOfTime::Resource'</span> <span class="structure">)</span><span class="operator">-&gt;</span><span class="word">to_app</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Let&#39;s show what that looks like in <code>Magpie</code>:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="version">5.24.0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">package</span> <span class="word">WasteOfTime::Resource</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">use</span> <span class="pragma">parent</span> <span class="words">qw(Magpie::Resource)</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="word">GET</span> <span class="prototype">( $self, $ctxt )</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">parent_handler</span><span class="operator">-&gt;</span><span class="word">resource</span><span class="structure">(</span><span class="symbol">$self</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">data</span><span class="structure">(</span><span class="word">scalar</span> <span class="word">localtime</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">response</span><span class="operator">-&gt;</span><span class="word">status</span><span class="structure">(</span><span class="number">200</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">Magpie::Constants::OK</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">}</span><br /><br /><span class="keyword">use</span> <span class="word">Plack::Builder</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Plack::Middleware::Magpie</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$app</span> <span class="operator">=</span> <span class="word">builder</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">enable</span> <span class="word">Magpie</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">accept_matrix</span> <span class="operator">=&gt;</span> <span class="structure">[</span> <span class="structure">[</span> <span class="word">json</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'application/json'</span><span class="structure">]</span> <span class="structure">]</span><span class="operator">,</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">pipeline</span>      <span class="operator">=&gt;</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">machine</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match</span> <span class="regexp">qr|^/$|</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'WasteOfTime::Resource'</span><span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_accept</span> <span class="single">'json'</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'Magpie::Transformer::JSON'</span><span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span></code><br />&nbsp;</td></table>

<p>So it&#39;s a little bit longer, but you probably discovered when you went to add the Jibber API that the original lacked routing for different APIs. So the extra lines are probably there in your app anyway. Let&#39;s step through and show what&#39;s going on in the new version.</p>

<p>We&#39;ve updated our standard boilerplate. We want to use signatures in our code now so it looks cleaner and more modern, and the things Perl 5.24.0 brings in are nice (postfix dereferencing knocked one of our elves&#39; socks clean off!). We also need to import Magpie Plack middleware. Unlike <code>Web::Machine</code>, <code>Magpie</code> doesn&#39;t automatically set up a PSGI application for you so we&#39;ll need <code>Plack::Builder</code>. After that we build the same <code>WasteOfTime::Resource</code> class but this time it&#39;s a <code>Magpie::Resource</code>.</p>

<p>Rather than splitting out the HTTP request cycle into the state machine that <code>Web::Machine</code> does, Plack hands everything to methods named after the HTTP Method. These methods take a copy of the instance (<code>$self</code>) and a &quot;context object&quot; (<code>$ctxt</code>). The context object is a holdover from Magpie&#39;s early days where it was much more generic. We also have to inform <code>Magpie</code> that *this class* is the resource, so we do that with the call to <code>parent_resource</code>. Finally, we need to respond with <code>scalar localtime</code> like we did the last time. Because we&#39;re a pipeline we can&#39;t be stateless, so we save the <code>localtime</code> to our <code>data</code> attribute. Set the response status, tell <code>Magpie</code> everything went OK, and we&#39;re done.</p>

<p>Notice at no point in the resource did we care what representations we could handle nor did we do any transformations. That&#39;s because that&#39;s handled in different stage in the pipeline by an entirely different class.</p>

<p>After the class we build the app. The last time this was handled for us by <code>Web::Machine</code>, <code>Magpie</code> however was built to handle more complex applications by default so the configuration is a bit more manual and more complex. First we use <code>Plack::Builder</code> and the <code>Magpie</code> middleware. The <code>Magpie</code> middleware gives us a little domain specific language (DSL) that is based off of <code>Plack::Builder</code>&#39;s. We tell Plack we&#39;re enabling <code>Magpie</code>. Then we set up the content types we can accept. Like before, we look for Accept headers that match the <code>application/json</code> content type. We tell magpie to call these <code>json</code>. Next, we set up the pipeline Machine for the application. The <code>match</code> directive matches the input URL (in this case the root &#39;/&#39;) and adds our resource accordingly. Finally, the <code>match_accept</code> header matches the accept type we setup earlier and adds the JSON transformer. In this case the JSON transformer that ships with <code>Magpie</code> is good enough for us.</p>

<h3 id="The-Magpies-Nest">The Magpie&#39;s Nest</h3>

<p>So in a more real world scenario we&#39;d not have a single resource but would instead have multiple resources doing many things.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Plack::Builder</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Plack::Middleware::Magpie</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$app</span> <span class="operator">=</span> <span class="word">builder</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">enable</span> <span class="word">Magpie</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">accept_matrix</span> <span class="operator">=&gt;</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="word">json</span>    <span class="operator">=&gt;</span> <span class="single">'application/vnd.northpole.gifts+json'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="word">xml</span>     <span class="operator">=&gt;</span> <span class="single">'application/vnd.northpole.gifts+xml'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="word">html_en</span> <span class="operator">=&gt;</span> <span class="single">'text/html'</span><span class="operator">,</span> <span class="core">undef</span><span class="operator">,</span> <span class="core">undef</span><span class="operator">,</span> <span class="single">'en'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="word">html_es</span> <span class="operator">=&gt;</span> <span class="single">'text/html'</span><span class="operator">,</span> <span class="core">undef</span><span class="operator">,</span> <span class="core">undef</span><span class="operator">,</span> <span class="single">'es'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="word">html_de</span> <span class="operator">=&gt;</span> <span class="single">'text/html'</span><span class="operator">,</span> <span class="core">undef</span><span class="operator">,</span> <span class="core">undef</span><span class="operator">,</span> <span class="single">'de'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">pipeline</span> <span class="operator">=&gt;</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'NP::Authen::Passwd'</span> <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="word">limit_user</span> <span class="operator">=&gt;</span> <span class="single">'Santa'</span> <span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">machine</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_template</span> <span class="single">'/TheList/{kid}'</span> <span class="operator">=&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span><span class="single">'NP::Resource::TheList.pm'</span><span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_template</span> <span class="single">'/TheList/{kid}/nice'</span> <span class="operator">=&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="single">'NP::Resource::Nice.pm'</span><span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_template</span> <span class="single">'/TheList/{kid}/naughty'</span> <span class="operator">=&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span><span class="single">'NP::Resource::Naughty.pm'</span><span class="structure">];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_accept</span> <span class="single">'json'</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'Magpie::Transformer::JSON'</span><span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_accept</span> <span class="single">'xml'</span>  <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'NP::Transformer::GiftsXML'</span><span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_accept</span> <span class="single">'html_en'</span> <span class="operator">=&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="single">'NP::Transformer::TT2'</span><span class="operator">,</span> <span class="single">'NP::I18N::EN'</span><span class="operator">,</span> <span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_accept</span> <span class="single">'html_es'</span> <span class="operator">=&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="single">'NP::Transformer::TT2'</span><span class="operator">,</span> <span class="single">'NP::I18N::ES'</span><span class="operator">,</span> <span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">match_accept</span> <span class="single">'html_de'</span> <span class="operator">=&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">[</span> <span class="single">'NP::Transformer::TT2'</span><span class="operator">,</span> <span class="single">'NP::I18N::DE'</span><span class="operator">,</span> <span class="structure">];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span></code><br />&nbsp;</td></table>

<p>As applications begin to scale in complexity, it becomes increasingly important to keep the different pieces of complexity corralled into their own places. While you can do this with <code>Web::Machine</code> and judicious use of base classes and roles, <code>Magpie</code> was designed to give you guidance on where to put things in an increasingly more complicated application.</p>

<p>As an example of how this would work, let&#39;s take a look at two of the output classes <code>NP::Transformer::TT2</code> and <code>NP::I18N::EN</code>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">NP::Transformer::TT2</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="version">5.24.0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="words">qw(signatures)</span><span class="structure">;</span><br /><br /><span class="word">extends</span> <span class="words">qw(Magpie::Transformer::TT2)</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">get_tt_conf</span><span class="prototype">($self, $ctxt)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="core">shift</span><span class="operator">-&gt;</span><span class="word">tt_conf</span><span class="structure">({</span> <span class="word">RELATIVE</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">OK</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">get_template</span><span class="prototype">($self, $ctxt)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">DECLINED</span> <span class="word">if</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">parent_handler</span><span class="operator">-&gt;</span><span class="word">has_error</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">template_file</span><span class="structure">(</span><span class="symbol">$ctxt</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">template</span><span class="structure">}</span> <span class="operator">//</span> <span class="single">'error.tt2'</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">response</span><span class="operator">-&gt;</span><span class="word">content_type</span><span class="structure">(</span><span class="single">'text/html'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">OK</span><span class="structure">;</span><br /><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">get_tt_vars</span><span class="prototype">($self, $ctxt)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">tt_vars</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">request</span>  <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">request</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">resource</span> <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">resource</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">OK</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span><br /><span class="separator">__END__</span></code><br />&nbsp;</td></table>

<p>This looks a little more complicated than it really is. First we&#39;re inheriting from <code>Magpie::Transformer::TT2</code> which handles building the <a href="https://metacpan.org/release/Template-Toolkit">Template Toolkit</a> object for us. We just need to provide some callback hooks. First <code>get_tt_conf</code> provides the configuration block, then <code>get_template</code> will look up the actual template name. We check for a <code>template</code> key in the context object. The context object is a great way to pass out-of-band data that is important to processing but really isn&#39;t resource data. If we don&#39;t have a template with the right name, we use a default error template, but we could just as easily throw an exception here.</p>

<p>Finally we set up the template variables. We pass in the request object (usually a <code>Plack::Request</code> object), and the Resource object (something similar to our <code>WasteOfTime::Resource</code> class above). This means that we can access the resource data directly and write a template like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synComment">&lt;!DOCTYPE html&gt;</span><br /><span class="synIdentifier">&lt;</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">head</span><span class="synIdentifier">&gt;&lt;</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>{The List}<span class="synIdentifier">&lt;/</span><span class="synStatement">title</span><span class="synIdentifier">&gt;&lt;/</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>{The List}<span class="synIdentifier">&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">article</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>{Nice}<span class="synIdentifier">&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[% FOR child IN resource.data.niceList %]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>[% child.name %] <span class="synSpecial">&amp;mdash;</span> [% child.gift %]<span class="synIdentifier">&lt;/</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[% END %]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">article</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">article</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>{Naughty}<span class="synIdentifier">&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[% FOR child IN resource.data.naughtyList %]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>[% child.name %] <span class="synSpecial">&amp;mdash;</span> [% child.coalAmount %] {lumps}<span class="synIdentifier">&lt;/</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[% END %]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">article</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span><br /><span class="synIdentifier">&lt;/</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span></code><br />&nbsp;</td></table>

<p>Notice our text strings look like <code>{Nice}</code>. This is because we expect the output from our template to be sent through a localization and internationalization (I18N) filter. The <code>NP::I18N::EN</code> class looks something like this:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">NP::I18N::EN</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="version">5.24.0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="words">qw(signatures)</span><span class="structure">;</span><br /><span class="word">extends</span> <span class="single">'Magpie::Transformer'</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Magpie::Constants</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Local::Simple</span><span class="structure">;</span><br /><br /><span class="word">__PACKAGE__</span><span class="operator">-&gt;</span><span class="word">register_events</span><span class="structure">(</span> <span class="words">qw( config transform )</span><span class="structure">);</span><br /><br /><span class="keyword">sub</span> <span class="word">load_queue</span> <span class="structure">{</span> <span class="keyword">return</span> <span class="words">qw(config transform)</span> <span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">config</span><span class="prototype">($self, $ctxt)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">l_lang</span><span class="structure">(</span><span class="single">'en_US'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">l_dir</span><span class="structure">(</span><span class="single">'locale'</span><span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">transform</span><span class="prototype">($self, $ctxt)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$html</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">resource</span><span class="operator">-&gt;</span><span class="word">data</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$html</span>   <span class="operator">=~</span> <span class="substitute">s|\{         # open brace<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([^}]+) # anything not a closing brace<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\}          # closing brace<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l(\1) # translate it<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|xgr</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">resource</span><span class="operator">-&gt;</span><span class="word">data</span><span class="structure">(</span><span class="symbol">$html</span><span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span><br /><span class="separator">__END__</span></code><br />&nbsp;</td></table>

<p>Because <code>Magpie</code> doesn&#39;t currently ship with an I18N framework, <code>NP::I18N</code> classes inherit directly from the <code>Magpie::Transformer</code> class. This means they&#39;re exposed to a bit more of the low-lying mechanics of setting up the state machine. This is what the call to <code>register_events</code> and the <code>load_queue</code> methods are for. They tell <code>Magpie</code> that we have two methods in this pipeline stage and the order in which to call them.</p>

<p>Assuming we have our <code>.po</code> files and whatnot set up properly, this will take any string in curly braces and replace it with the appropriate translation. Obviously this is a vastly simplified version, and Santa&#39;s real system probably uses a much more complex parsing system for pulling out the message IDs and translation strings so that things like the coal count can be translated properly. But this illustrates how a pipeline of pieces means that as we step through each piece of the application we can focus down and work on each step individually.</p>

<h3 id="La-gazza-ladra">La gazza ladra</h3>

<p><code>Magpie</code> is heavily influenced by a number of different things. You may recognize some mod_perl and some Catalyst. We used both of those extensively before sitting down to write <code>Magpie</code>. The <code>match_template</code> directive matches on <a href="https://tools.ietf.org/html/rfc6570">URI`Templates</a>. It was also heavily influenced by the book <a href="http://restinpractice.com/book/">Rest In Practice</a> and the work of <a href="http://www.amundsen.com">Mike Amundsen</a>.</p>

<p>As I mentioned in the introduction it&#39;s still very much a work in progress but if you&#39;d like to take it for a spin, <code>#magpie</code> on <code>irc.perl.org</code> can answer your questions.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/72ca0434d6998fb97198f278926c6abf?r=g&s=80&d=retro />
This article contributed by: Chris Prather &lt;chris@prather.org&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Combining wishlists for production and shipping planning" href="2016-12-10.html">Previous</a></li>

    <li class="next"><a title="Trying for a Happy Christmas" href="2016-12-12.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





